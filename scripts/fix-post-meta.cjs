// fix-post-meta.cjs
 const fs = require("fs");
const path = require("path");
const cheerio = require("cheerio");

const distDir = path.join(__dirname, "..", "dist");
const postsDir = path.join(__dirname, "..", "posts"); // changed from 'dist' to 'posts'
const outputPath = path.join(__dirname, "post-meta.js");

const postMetadata = {};

fs.readdirSync(distDir).forEach((file) => {
  if (!file.endsWith(".html")) return;
try {
  const files = fs.readdirSync(postsDir);

  const slug = file.replace(".html", "");
  const html = fs.readFileSync(path.join(distDir, file), "utf8");
  const $ = cheerio.load(html);
  files.forEach((file) => {
    if (!file.endsWith(".html")) return;

  const title = $("head title").text().trim();
  const description = $('meta[name="description"]').attr("content")?.trim();
  const keywords = $('meta[name="keywords"]').attr("content")?.trim();
  const ogImage = $('meta[property="og:image"]').attr("content")?.trim()
    || "https://read.maxclickempire.com/assets/og-image.jpg";
    const slug = file.replace(".html", "");
    const html = fs.readFileSync(path.join(postsDir, file), "utf8");
    const $ = cheerio.load(html);
    const title = $("head title").text().trim();
    const description = $('meta[name="description"]').attr("content")?.trim() || "";
    const keywords = $('meta[name="keywords"]').attr("content")?.trim() || "";
    const ogImage = $('meta[property="og:image"]').attr("content")?.trim()
      || "https://read.maxclickempire.com/assets/og-image.jpg";
    if (!title || !description) {
      console.warn(`⚠️ Skipped ${file} due to missing title or description.`);
      return;
    }

  // Skip pages missing key SEO info to avoid orphan posts
  if (title && description) {
    postMetadata[slug] = {
      title,
      description,
      keywords: keywords || "",
      keywords,
      image: ogImage,
      published: new Date().toISOString()
    };
  }
});
  });

const output = `// Auto-generated by Supreme SEO Engine — Do Not Edit
  // Create the output JS content
  const output = `// Auto-generated by Supreme SEO Engine — Do Not Edit
const postMetadata = ${JSON.stringify(postMetadata, null, 2)};
@@ -44,5 +50,8 @@ if (typeof module !== 'undefined' && module.exports) {
}
`;

fs.writeFileSync(outputPath, output);
console.log("✅ post-meta.js updated successfully.");
  fs.writeFileSync(outputPath, output);
  console.log("✅ post-meta.js updated successfully.");
} catch (err) {
  console.error("❌ Error updating post metadata:", err);
}