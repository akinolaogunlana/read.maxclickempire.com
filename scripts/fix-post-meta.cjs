// scripts/update-post-meta.cjs
const fs = require("fs");
const path = require("path");

const distDir = path.join(__dirname, "..", "dist");
const metaPath = path.join(__dirname, "..", "data", "post-meta.js");

function extractMeta(html) {
  const titleMatch = html.match(/<title>(.*?)<\/title>/i);
  const descMatch = html.match(/<meta\s+name=["']description["']\s+content=["'](.*?)["']/i);
  const keywordsMatch = html.match(/<meta\s+name=["']keywords["']\s+content=["'](.*?)["']/i);

  return {
    title: titleMatch?.[1] || "",
    description: descMatch?.[1] || "",
    keywords: keywordsMatch?.[1] || ""
  };
}

const metadata = {};

fs.readdirSync(distDir).forEach(file => {
  if (file.endsWith(".html")) {
    const filePath = path.join(distDir, file);
    const html = fs.readFileSync(filePath, "utf8");

    const { title, description, keywords } = extractMeta(html);
    const slug = path.basename(file, ".html");

    metadata[slug] = { title, description, keywords };
  }
});

const finalOutput = `// Auto-generated by update-post-meta.cjs — Do Not Edit

const postMetadata = ${JSON.stringify(metadata, null, 2)};

if (typeof module !== 'undefined' && module.exports) {
  module.exports.postMetadata = postMetadata;
} else if (typeof window !== 'undefined') {
  window.postMetadata = postMetadata;
}
`;

fs.writeFileSync(metaPath, finalOutput, "utf8");
console.log("✅ post-meta.js updated successfully from /dist/*.html");